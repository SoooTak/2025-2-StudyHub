<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${study.title} + ' - 게시글 - StudyHub'">게시글 - StudyHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 전역 화이트 테마 -->
    <link rel="stylesheet" th:href="@{/css/studyhub.css}">

    <!-- 이 페이지 전용 스타일 -->
    <style>
        * { box-sizing: border-box; }

        .detail-main {
            max-width: 1040px;
            margin: 0 auto;
        }

        .top-actions {
            margin-top: 4px;
            margin-bottom: 10px;
        }

        .post-header {
            margin-top: 4px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .badge-notice {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background-color: #fff4e0;
            border: 1px solid #f0c27b;
            color: #b07219;
            margin-right: 6px;
        }
        .post-meta {
            margin-top: 6px;
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .post-meta span { margin-right: 12px; }

        .post-content {
            margin-top: 14px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .post-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            font-size: 13px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-danger {
            background-color: #dc2626;
            color: #ffffff;
        }

        .comment-section {
            margin-top: 26px;
            padding-top: 18px;
            border-top: 1px dashed var(--color-border-subtle);
        }
        .comment-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .comment-list { margin-bottom: 16px; }
        .comment-item {
            padding: 8px 0;
            border-bottom: 1px solid #eef1f9;
            font-size: 13px;
        }
        .comment-meta {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }
        .comment-body { white-space: pre-wrap; }
        .comment-actions {
            margin-top: 4px;
            font-size: 12px;
        }
        .comment-actions a,
        .comment-actions form {
            display: inline-block;
            margin-right: 4px;
        }
        .comment-actions button {
            padding: 3px 8px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 11px;
        }
        .comment-edit {
            background-color: #e6f0ff;
            color: #1f3b8f;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
        }
        .comment-delete {
            background-color: #ffe8e6;
            color: #a22024;
        }

        .comment-edit-form textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #cfd5e8;
            min-height: 70px;
            resize: vertical;
            font-size: 13px;
        }
        .comment-edit-form textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px rgba(37,99,235,0.12);
        }

        .comment-form-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .comment-form-row label { font-weight: 500; }
        .comment-form-row textarea {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #cfd5e8;
            min-height: 80px;
            resize: vertical;
        }
        .comment-form-row textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px rgba(37,99,235,0.12);
        }
    </style>
</head>
<body>

<!-- 사이트 공통 헤더 -->
<th:block th:replace="fragments/header :: header"></th:block>

<!-- 스터디룸 상단 탭 (게시판 탭 활성화) -->
<header class="room-header">
    <div style="display:flex;align-items:center;gap:14px;">
        <a class="room-brand" th:href="@{|/room/${study.id}|}"
           th:text="${study != null ? study.title : '스터디'}">스터디</a>
        <nav class="room-nav">
            <a th:href="@{|/room/${study.id}|}">홈</a>
            <a th:href="@{|/room/${study.id}/sessions|}">출석</a>
            <a class="active" th:href="@{|/room/${study.id}/board|}">게시판</a>
            <a th:href="@{|/room/${study.id}/files|}">자료실</a>
            <a th:href="@{|/room/${study.id}/members|}">멤버</a>
        </nav>
    </div>
    <div class="room-header-right">
        <span class="role-badge" th:if="${myRole != null}" th:text="${myRole}">MEMBER</span>
        <a class="btn-secondary" th:href="@{/studies}">다른 스터디 둘러보기</a>
    </div>
</header>

<main class="page-container">
    <section class="card detail-main">
        <h2 class="section-title" th:text="${study.title} + ' - 게시글'">게시글</h2>

        <div class="top-actions">
            <a th:href="@{'/room/' + ${study.id} + '/board'}" class="btn btn-secondary">
                ← 게시글 목록
            </a>
        </div>

        <div class="post-header">
            <div>
                <span th:if="${post.type.name() == 'NOTICE'}" class="badge-notice">공지</span>
                <span th:text="${post.title}">제목</span>
            </div>
            <div class="post-meta">
                <span th:text="'작성자: ' + ${post.writer.nickname}">작성자</span>
                <span th:text="'작성일: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
            </div>
        </div>

        <div class="post-content" th:text="${post.content}">
            내용
        </div>

        <div class="post-actions">
            <!-- 자기 글인 경우에만 수정 버튼 -->
            <a th:if="${isOwner}"
               th:href="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/edit'}"
               class="btn btn-secondary">수정</a>

            <!-- 자기 글 또는 리더/매니저/관리자만 삭제 -->
            <form th:if="${canDelete}"
                  th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/delete'}"
                  method="post">
                <button type="submit" class="btn btn-danger">삭제</button>
            </form>
        </div>

        <!-- 댓글 영역 -->
        <div class="comment-section">
            <div class="comment-title">댓글</div>

            <div class="comment-list">
                <div th:if="${#lists.isEmpty(comments)}" class="comment-item">
                    아직 댓글이 없습니다.
                </div>

                <div th:each="c : ${comments}" class="comment-item">
                    <div class="comment-meta">
                        <span th:text="${c.writer.nickname}">닉네임</span>
                        <span th:text="${#temporals.format(c.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                    </div>

                    <!-- 원본 내용 -->
                    <div class="comment-body"
                         th:attr="id=${'comment-text-' + c.id}"
                         th:text="${c.content}">
                        댓글 내용
                    </div>

                    <!-- 인라인 수정 폼 (자기 댓글인 경우에만 존재) -->
                    <form th:if="${c.writer.id == currentUserId}"
                          class="comment-edit-form"
                          th:attr="id=${'comment-edit-form-' + c.id}"
                          th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments/' + ${c.id} + '/edit'}"
                          method="post"
                          style="display:none; margin-top:6px;">
                        <textarea name="content" required th:text="${c.content}"></textarea>
                        <div style="margin-top:4px; display:flex; gap:6px;">
                            <button type="submit"
                                    class="btn btn-primary"
                                    style="padding:3px 10px; font-size:12px;">저장</button>
                            <button type="button"
                                    class="btn btn-secondary"
                                    style="padding:3px 10px; font-size:12px;"
                                    th:attr="onclick=|cancelEdit(${c.id})|">취소</button>
                        </div>
                    </form>

                    <div class="comment-actions"
                         th:attr="id=${'comment-actions-' + c.id}">
                        <!-- 자기 댓글 → 수정 버튼 -->
                        <button type="button"
                                th:if="${c.writer.id == currentUserId}"
                                class="comment-edit"
                                th:attr="onclick=|startEdit(${c.id})|">
                            수정
                        </button>

                        <!-- 댓글 작성자 또는 리더/매니저/관리자만 삭제 가능 -->
                        <form th:if="${c.writer.id == currentUserId or isLeaderOrManager or isAdmin}"
                              th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments/' + ${c.id} + '/delete'}"
                              method="post">
                            <button type="submit" class="comment-delete">삭제</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 댓글 작성 폼 -->
            <form th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments'}"
                  method="post"
                  th:object="${commentForm}">
                <div class="comment-form-row">
                    <label for="content">댓글 내용</label>
                    <textarea id="content" th:field="*{content}" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">댓글 등록</button>
            </form>
        </div>
    </section>
</main>

<script>
    function startEdit(id) {
        var text = document.getElementById('comment-text-' + id);
        var form = document.getElementById('comment-edit-form-' + id);
        var actions = document.getElementById('comment-actions-' + id);
        if (text && form) {
            text.style.display = 'none';
            form.style.display = 'block';
        }
        if (actions) {
            actions.style.display = 'none';
        }
    }
    function cancelEdit(id) {
        var text = document.getElementById('comment-text-' + id);
        var form = document.getElementById('comment-edit-form-' + id);
        var actions = document.getElementById('comment-actions-' + id);
        if (text && form) {
            form.style.display = 'none';
            text.style.display = 'block';
        }
        if (actions) {
            actions.style.display = 'block';
        }
    }
</script>

</body>
</html>
