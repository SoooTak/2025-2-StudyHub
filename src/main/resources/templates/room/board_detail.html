<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${study.title} + ' - 게시글 - StudyHub'">게시글 - StudyHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fb;
        }
        a { text-decoration: none; color: inherit; }
        header {
            background-color: #1f3b8f;
            color: #ffffff;
            padding: 12px 20px;
        }
        .header-inner {
            max-width: 1040px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-weight: 700; font-size: 20px; }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        .nav-links a {
            padding: 6px 10px;
            border-radius: 999px;
        }
        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.16);
        }
        .login-email {
            font-size: 13px;
            opacity: 0.9;
        }

        main {
            max-width: 1040px;
            margin: 24px auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            padding: 22px 26px 30px;
        }
        h1 { margin: 0; font-size: 22px; }

        .top-actions {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .post-header {
            margin-top: 4px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e4f0;
        }
        .badge-notice {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background-color: #fff4e0;
            border: 1px solid #f0c27b;
            color: #b07219;
            margin-right: 6px;
        }
        .post-meta {
            margin-top: 6px;
            font-size: 13px;
            color: #666;
        }
        .post-meta span { margin-right: 12px; }

        .post-content {
            margin-top: 14px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .post-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            font-size: 13px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-primary { background-color: #1f3b8f; color: #ffffff; }
        .btn-secondary {
            background-color: #ffffff;
            color: #1f3b8f;
            border: 1px solid #c6cfeb;
        }
        .btn-danger { background-color: #d03232; color: #ffffff; }

        .comment-section {
            margin-top: 26px;
            padding-top: 18px;
            border-top: 1px dashed #d0d7ec;
        }
        .comment-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .comment-list { margin-bottom: 16px; }
        .comment-item {
            padding: 8px 0;
            border-bottom: 1px solid #eef1f9;
            font-size: 13px;
        }
        .comment-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .comment-body { white-space: pre-wrap; }
        .comment-actions {
            margin-top: 4px;
            font-size: 12px;
        }
        .comment-actions a,
        .comment-actions form {
            display: inline-block;
            margin-right: 4px;
        }
        .comment-actions button {
            padding: 3px 8px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 11px;
        }
        .comment-edit {
            background-color: #e6f0ff;
            color: #1f3b8f;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
        }
        .comment-delete {
            background-color: #ffe8e6;
            color: #a22024;
        }

        .comment-edit-form textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #cfd5e8;
            min-height: 70px;
            resize: vertical;
            font-size: 13px;
        }
        .comment-edit-form textarea:focus {
            outline: none;
            border-color: #1f3b8f;
            box-shadow: 0 0 0 1px rgba(31,59,143,0.12);
        }

        .comment-form-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .comment-form-row label { font-weight: 500; }
        .comment-form-row textarea {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #cfd5e8;
            min-height: 80px;
            resize: vertical;
        }
        .comment-form-row textarea:focus {
            outline: none;
            border-color: #1f3b8f;
            box-shadow: 0 0 0 1px rgba(31,59,143,0.12);
        }

        @media (max-width: 640px) {
            main {
                margin: 0;
                border-radius: 0;
            }
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="header-inner">
        <div class="logo">
            <a href="/" style="color:#ffffff;">StudyHub</a>
        </div>
        <div class="nav-links">
            <a href="/">홈</a>
            <a href="/studies">스터디 탐색</a>
            <span th:if="${loggedIn}" class="login-email" th:text="${loginEmail}">user@example.com</span>
            <a th:if="${loggedIn}" href="/logout">로그아웃</a>
            <a th:if="${!loggedIn}" href="/login">로그인</a>
            <a th:if="${!loggedIn}" href="/signup">회원가입</a>
        </div>
    </div>
</header>

<main>
    <h1 th:text="${study.title} + ' - 게시글'">게시글</h1>

    <div class="top-actions">
        <a th:href="@{'/room/' + ${study.id} + '/board'}" class="btn btn-secondary">
            ← 게시글 목록
        </a>
    </div>

    <div class="post-header">
        <div>
            <span th:if="${post.type.name() == 'NOTICE'}" class="badge-notice">공지</span>
            <span th:text="${post.title}">제목</span>
        </div>
        <div class="post-meta">
            <span th:text="'작성자: ' + ${post.writer.nickname}">작성자</span>
            <span th:text="'작성일: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
        </div>
    </div>

    <div class="post-content" th:text="${post.content}">
        내용
    </div>

    <div class="post-actions">
        <!-- 자기 글인 경우에만 수정 버튼 -->
        <a th:if="${isOwner}"
           th:href="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/edit'}"
           class="btn btn-secondary">수정</a>

        <!-- 자기 글 또는 리더/매니저/관리자만 삭제 -->
        <form th:if="${canDelete}"
              th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/delete'}"
              method="post">
            <button type="submit" class="btn btn-danger">삭제</button>
        </form>
    </div>

    <!-- 댓글 영역 -->
    <div class="comment-section">
        <div class="comment-title">댓글</div>

        <div class="comment-list">
            <div th:if="${#lists.isEmpty(comments)}" class="comment-item">
                아직 댓글이 없습니다.
            </div>

            <div th:each="c : ${comments}" class="comment-item">
                <div class="comment-meta">
                    <span th:text="${c.writer.nickname}">닉네임</span>
                    <span th:text="${#temporals.format(c.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                </div>

                <!-- 원본 내용 -->
                <div class="comment-body"
                     th:attr="id=${'comment-text-' + c.id}"
                     th:text="${c.content}">
                    댓글 내용
                </div>

                <!-- 인라인 수정 폼 (자기 댓글인 경우에만 존재) -->
                <form th:if="${c.writer.id == currentUserId}"
                      class="comment-edit-form"
                      th:attr="id=${'comment-edit-form-' + c.id}"
                      th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments/' + ${c.id} + '/edit'}"
                      method="post"
                      style="display:none; margin-top:6px;">
                    <textarea name="content" required th:text="${c.content}"></textarea>
                    <div style="margin-top:4px; display:flex; gap:6px;">
                        <button type="submit"
                                class="btn btn-primary"
                                style="padding:3px 10px; font-size:12px;">저장</button>
                        <button type="button"
                                class="btn btn-secondary"
                                style="padding:3px 10px; font-size:12px;"
                                th:attr="onclick=|cancelEdit(${c.id})|">취소</button>
                    </div>
                </form>

                <div class="comment-actions"
                     th:attr="id=${'comment-actions-' + c.id}">
                    <!-- 자기 댓글 → 수정 버튼 -->
                    <button type="button"
                            th:if="${c.writer.id == currentUserId}"
                            class="comment-edit"
                            th:attr="onclick=|startEdit(${c.id})|">
                        수정
                    </button>

                    <!-- 댓글 작성자 또는 리더/매니저/관리자만 삭제 가능 -->
                    <form th:if="${c.writer.id == currentUserId or isLeaderOrManager or isAdmin}"
                          th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments/' + ${c.id} + '/delete'}"
                          method="post">
                        <button type="submit" class="comment-delete">삭제</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 댓글 작성 폼 -->
        <form th:action="@{'/room/' + ${study.id} + '/board/' + ${post.id} + '/comments'}"
              method="post"
              th:object="${commentForm}">
            <div class="comment-form-row">
                <label for="content">댓글 내용</label>
                <textarea id="content" th:field="*{content}" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">댓글 등록</button>
        </form>
    </div>
</main>

<script>
    function startEdit(id) {
        var text = document.getElementById('comment-text-' + id);
        var form = document.getElementById('comment-edit-form-' + id);
        var actions = document.getElementById('comment-actions-' + id);
        if (text && form) {
            text.style.display = 'none';
            form.style.display = 'block';
        }
        if (actions) {
            actions.style.display = 'none';
        }
    }
    function cancelEdit(id) {
        var text = document.getElementById('comment-text-' + id);
        var form = document.getElementById('comment-edit-form-' + id);
        var actions = document.getElementById('comment-actions-' + id);
        if (text && form) {
            form.style.display = 'none';
            text.style.display = 'block';
        }
        if (actions) {
            actions.style.display = 'block';
        }
    }
</script>

</body>
</html>
