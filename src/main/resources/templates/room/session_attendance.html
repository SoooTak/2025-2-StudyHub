<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${study.title} + ' - 출석부 - StudyHub'">출석부 - StudyHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 전역 화이트 테마 -->
    <link rel="stylesheet" th:href="@{/css/studyhub.css}">

    <!-- 이 페이지 전용 스타일 -->
    <style>
        .attendance-table-main {
            max-width: 1040px;
            margin: 0 auto;
        }

        .meta {
            margin-top: 8px;
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .meta span {
            margin-right: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
            font-size: 13px;
        }
        thead {
            background-color: #eff6ff;
        }
        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }
        th {
            font-weight: 600;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--color-border-subtle);
            font-size: 12px;
        }
        .status-present {
            background-color: #ecfdf3;
            border-color: #bbf7d0;
            color: #166534;
        }
        .status-late {
            background-color: #fef3c7;
            border-color: #facc15;
            color: #854d0e;
        }
        .status-absent {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #b91c1c;
        }
        .status-none {
            background-color: #f3f4f6;
            border-color: #e5e7eb;
            color: #6b7280;
        }

        .edit-form {
            margin-top: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .edit-form select {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid var(--color-border-subtle);
        }
        .edit-form button {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: none;
            background-color: var(--color-primary);
            color: #ffffff;
            cursor: pointer;
        }
        .edit-form button:hover {
            background-color: var(--color-primary-strong);
        }

        .back-link {
            display: inline-block;
            margin-top: 16px;
            font-size: 13px;
            color: var(--color-primary);
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<!-- 사이트 공통 헤더 -->
<th:block th:replace="fragments/header :: header"></th:block>

<!-- 스터디룸 상단 탭 (출석 탭 활성) -->
<header class="room-header">
    <div style="display:flex;align-items:center;gap:14px;">
        <a class="room-brand" th:href="@{|/room/${study.id}|}"
           th:text="${study != null ? study.title : '스터디'}">스터디</a>
        <nav class="room-nav">
            <a th:href="@{|/room/${study.id}|}">홈</a>
            <a class="active" th:href="@{|/room/${study.id}/sessions|}">출석</a>
            <a th:href="@{|/room/${study.id}/board|}">게시판</a>
            <a th:href="@{|/room/${study.id}/files|}">자료실</a>
            <a th:href="@{|/room/${study.id}/members|}">멤버</a>
        </nav>
    </div>
    <div class="room-header-right">
        <span class="role-badge" th:if="${myRole != null}" th:text="${myRole}">LEADER</span>
        <a class="btn-secondary" th:href="@{/studies}">다른 스터디 둘러보기</a>
    </div>
</header>

<main class="page-container">
    <section class="card attendance-table-main">
        <h2 class="section-title" th:text="${study.title} + ' - 출석부'">출석부</h2>
        <div class="meta">
            <span th:text="'세션 제목: ' + ${studySession.title}">세션 제목</span>
            <span th:text="'일시: ' + ${#temporals.format(studySession.sessionDateTime, 'yyyy-MM-dd HH:mm')}">일시</span>
        </div>

        <table>
            <thead>
            <tr>
                <th>회원</th>
                <th>이메일</th>
                <th>출석 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="member : ${members}"
                th:with="status=${memberStatusMap[member.user.id]}">
                <td th:text="${member.user.nickname}">닉네임</td>
                <td th:text="${member.user.email}">email@example.com</td>
                <td>
                    <!-- 현재 상태 배지 -->
                    <span class="status-badge" th:switch="${status}">
                        <span th:case="'PRESENT'" class="status-present">출석</span>
                        <span th:case="'LATE'" class="status-late">지각</span>
                        <span th:case="'ABSENT'" class="status-absent">결석</span>
                        <span th:case="*" class="status-none">미체크</span>
                    </span>

                    <!-- 리더/매니저인 경우 상태 변경 폼 -->
                    <div class="edit-form" th:if="${isLeader} or ${isManager}">
                        <form th:action="@{'/room/' + ${study.id} +
                                           '/sessions/' + ${studySession.id} +
                                           '/attendance/' + ${member.user.id} + '/update'}"
                              method="post"
                              style="display:flex;gap:4px;align-items:center;">
                            <select name="status">
                                <option value="PRESENT"
                                        th:selected="${status} == 'PRESENT'">출석</option>
                                <option value="LATE"
                                        th:selected="${status} == 'LATE'">지각</option>
                                <option value="ABSENT"
                                        th:selected="${status} == 'ABSENT'">결석</option>
                            </select>
                            <button type="submit">변경</button>
                        </form>
                    </div>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(members)}">
                <td colspan="3">아직 이 스터디에 가입된 멤버가 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <a th:href="@{'/room/' + ${study.id} + '/sessions'}" class="back-link">← 세션 목록으로 돌아가기</a>
    </section>
</main>

</body>
</html>
